/*
 * runSharedGasBurner.cpp
 *
 *  Created on: 06-Oct-2021
 *      Author: amit
 */




#include "runSharedGasBurner.h"

int runSharedGasBurner(std::unique_ptr<MATLABEngine> &ep, user_inputs::ptr user, std::vector<double> initial_CE_values, intermediateResult::ptr intermediate) {

	std::string cmd4 = "time_horizon = ";
	cmd4.append(to_string(user->getTimeHorizon()));
	cmd4.append(";");
	ep->eval(convertUTF8StringToUTF16String(cmd4));

	cmd4 = "time_step = ";
	cmd4.append(to_string(user->getSampleTime()));
	cmd4.append(";");
	ep->eval(convertUTF8StringToUTF16String(cmd4));

	cmd4 = "x0_0 = ";
	cmd4.append(to_string(initial_CE_values[0]));
	cmd4.append(";");
	ep->eval(convertUTF8StringToUTF16String(cmd4));

	cmd4 = "x1_0 = ";
	cmd4.append(to_string(initial_CE_values[1]));
	cmd4.append(";");
	ep->eval(convertUTF8StringToUTF16String(cmd4));



	unsigned int execution_count = user->getNumberMatlabSimulationExecuted();



	std::string cmd="cd ", cmd2=" && rm result.txt";
	cmd.append(intermediate->getMatlabPathForOriginalModel());
	cmd.append(cmd2);
	//std::cout << "cmd = " << cmd << std::endl;

	//Removing the files generated by Matlab in the previous run
	if (execution_count == 0) {	//running for the first time

		int x = system(cmd.c_str());
		if (x == -1) {
			std::cout <<"Error executing cmd: " << cmd <<std::endl;
		}
		//system("cd ../src/benchmark/oscillator && rm result.tsv");	//most important file is result.tsv others I may see later if need arise
		cmd="addpath (genpath('";
		cmd.append(intermediate->getMatlabPathForOriginalModel());
		cmd.append("'))");

		//calling the script file "test1CPP.m"   Make sure this script file is in the folder from where you are executing
		//engEvalString(ep, "addpath (genpath('../src/benchmark/oscillator'))"); //Since tool BBC4CPS will be executed from Release or Debug

		ep->eval(convertUTF8StringToUTF16String(cmd));

	}

	cmd="cd('";
	cmd.append(intermediate->getMatlabPathForOriginalModel());
	cmd.append("')");
	//engEvalString(ep, "cd('../src/benchmark/oscillator')");
	//engEvalString(ep, cmd.c_str());	//This command will not affect if it is already in the same folder

	ep->eval(convertUTF8StringToUTF16String(cmd));



	/*//Removing the files generated by Matlab in the previous run
	if (execution_count == 0) {	//running for the first time
		system("cd ../src/benchmark/shared_gas_burner && rm result.tsv");	//most important file is result.tsv others I may see later if need arise
		//calling the script file "test1CPP.m"   Make sure this script file is in the folder from where you are executing
		engEvalString(ep, "addpath (genpath('../src/benchmark/shared_gas_burner'))"); //Since tool BBC4CPS will be executed from Release or Debug
		engEvalString(ep, "cd('../src/benchmark/shared_gas_burner')");
	}*/


	//ep->eval(convertUTF8StringToUTF16String("run_SharedGasBurner"));
	ep->eval(u"run_SharedGasBurner");

	//This code can be used for other Models also.
	/*engEvalString(ep, "plot(x1,x2);");
	engEvalString(ep, "title('x1 vs. x2 of the Plot');");
	engEvalString(ep, "xlabel('x1');");
	engEvalString(ep, "ylabel('x2');");*/

	printf("Done Calling Matlab's Simulink (simulation)\n");

	return EXIT_SUCCESS;
}


